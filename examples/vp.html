<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Verifiable Presentation</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <script src="https://cdn.jsdelivr.net/gh/ethereumjs/browser-builds/dist/ethereumjs-tx/ethereumjs-tx-1.3.3.min.js"></script>
    <script src="https://storage.googleapis.com/google-code-archive-downloads/v2/code.google.com/vkbeautify/vkbeautify.0.99.00.beta.js"></script>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="col">
          <div class="mb-3">
            <label for="content" class="form-label">VP Object</label>
            <textarea class="form-control" id="content" rows="9">
{
  "@context": ["https://www.w3.org/2018/credentials/v1"],
  "holder": "id:#issuer",
  "id": "id", 
  "type": ["VerifiablePresentation"],
  "verifiableCredential": [
    {
      "@context": [],
      "credentialStatus": null,
      "credentialSubject": null,
      "id": "id:1",
      "issuer": "id:1#issuer",
      "name": "Test Issuer",
      "proof": {
        "algorithm": "EdDSA",
        "created": "2024-08-22T08:33:13.735970700+00:00",
        "jws": "FDdaNuqLlggEQainuOQhkiIv4hWKsVVOqLgtATa0S1zgALlPSR4_V9uU9fClw8f_oJ_vVZ1Yuf_-r4sJC7iXAg",
        "proofPurpose": "ESig",
        "type": "FiProof"
      },
      "type": ["VerifiableCredential"],
      "validFrom": "2024-08-22T08:33:13.735475600+00:00"
    },
    {
      "@context": [],
      "credentialStatus": null,
      "credentialSubject": null,
      "id": "id:2",
      "issuer": "id:2#issuer",
      "name": "Test Issuer",
      "proof": {
        "algorithm": "EdDSA",
        "created": "2024-08-22T08:33:13.735980200+00:00",
        "jws": "q-9rfghN4qu6PHh_-53fxX8N8KnMn-zz3xxSJmzMdvOfoP2ksIXvOkeElovoVfa5KW47qL7T2YAAVnZXUba3BQ",
        "proofPurpose": "ESig",
        "type": "FiProof"
      },
      "type": ["VerifiableCredential"],
      "validFrom": "2024-08-22T08:33:13.735924500+00:00"
    }
  ]
  }
</textarea
            >
          </div>
        </div>
        <div class="col">
          <div class="mb-3">
            <div class="mb-3">
              <select
                id="alg"
                class="form-select"
                aria-label="Select Algorithm"
              >
                <option value="RS256">RS256</option>
                <option value="RS384">RS384</option>
                <option value="RS512">RS512</option>
                <option value="PS256">PS256</option>
                <option value="PS384">PS384</option>
                <option value="PS512">PS512</option>
                <option value="ES256">ES256</option>
                <option value="ES384">ES384</option>
                <option value="ES512">ES512</option>
                <option value="EdDSA" selected>EDDSA</option>
              </select>
              <label for="private-key-hex" class="form-label"
                >Private Key Hex</label
              >
              <textarea class="form-control" id="private-key-hex" rows="3">
aa7f263d0a1a671a4c06ea22800c1391dd8974174f01d0e5a848fe51bdd1bcf8</textarea
              >
              <label for="public-key-hex" class="form-label"
                >Public Key Hex</label
              >
              <textarea class="form-control" id="public-key-hex" rows="3">
7b6df71975950d5ea15ac090c57d462f73d3a48644fbcf2c6d5db838adf136b5</textarea
              >
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div
          class="col py-4 px-2"
          style="background-color: black; color: white; border-radius: 10px"
        >
          <div>Signed VP Content</div>
          <hr />
          <pre id="signed-content"></pre>
        </div>
      </div>
    </div>
    <script type="module" defer>
      import init, {
        VC,
        VerificationDocument,
        Algorithm,
        ProofType,
      } from "/pkg/fi_verifiable_data.js";

      let content = document.getElementById("content"),
        private_key_hex = document.getElementById("private-key-hex"),
        public_key_hex = document.getElementById("public-key-hex"),
        alg = document.getElementById("alg");

      const sign = async () => {
        await init();

        let vc = VC.from(JSON.parse(content.value));

        const privateKeyBytes = Uint8Array.from(
          ethereumjs.Buffer.Buffer.from(
            "7b6df71975950d5ea15ac090c57d462f73d3a48644fbcf2c6d5db838adf136b5",
            "hex"
          )
        );
        let verificationDocument = new VerificationDocument(
          "",
          privateKeyBytes,
          null
        );

        let algorithm;
        switch (alg.value) {
          case "RS256":
            algorithm = Algorithm.RS256;
            break;
          case "RS384":
            algorithm = Algorithm.RS384;
            break;
          case "RS512":
            algorithm = Algorithm.RS512;
            break;
          case "PS256":
            algorithm = Algorithm.PS256;
            break;
          case "PS384":
            algorithm = Algorithm.PS384;
            break;
          case "PS512":
            algorithm = Algorithm.PS512;
            break;
          case "ES256":
            algorithm = Algorithm.ES256;
            break;
          case "ES384":
            algorithm = Algorithm.ES384;
            break;
          case "ES512":
            algorithm = Algorithm.ES512;
            break;
          case "EdDSA":
            algorithm = Algorithm.EdDSA;
            break;
        }

        try {
          vc.sign(
            algorithm,
            "purpose",
            verificationDocument,
            ProofType.FiProof
          );
        } catch (error) {
          console.error(error);
        }

        let signedOutput = document.getElementById("signed-content");
        signedOutput.textContent = vkbeautify.json(
          JSON.stringify(vc.toObject()),
          4
        );
      };

      sign();

      content.onchange = sign;
      content.onkeyup = sign;
      private_key_hex.onchange = sign;
      private_key_hex.onkeyup = sign;
      public_key_hex.onchange = sign;
      public_key_hex.onkeyup = sign;
      alg.onchange = sign;
    </script>
  </body>
</html>
